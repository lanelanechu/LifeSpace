<!DOCTYPE html>
<html lang="zh-TW">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>活動總覽</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">


    <link href="images/favicon.ico" rel="icon">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600&family=Inter:wght@700;800&display=swap"
          rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="css/animate.min.css" rel="stylesheet">
    <link href="css/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap2.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.6.1/dist/nouislider.min.css" />

    <!-- Template Stylesheet -->
    <link href="css/style.css" rel="stylesheet">
    
    <!-- 瀏覽活動 -->
   	<link rel="stylesheet" href="css/event_overview.css">


</head>

<body>
     
     <div class="container-xxl bg-white p-0">

 <!-- Spinner Start -->
        <div id="spinner"
             class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
        <!-- Spinner End -->
        
        <!-- Header Navbar Start -->
        <div class="container-fluid nav-bar bg-transparent">
            <nav class="navbar navbar-expand-lg bg-white navbar-light py-0 px-4">
                <a href="homepage.html" class="navbar-brand d-flex align-items-center text-center">
                    <div class="icon p-2 me-2">
                        <img class="img-fluid" src="images/img.bootstrap/LifeSpace.png" alt="Icon" style="width: 30px; height: 30px;">
                    </div>
                    <img class="img-fluid" src="images/img.bootstrap/LifeSpace2.png" alt="Icon" style="width: 200px; height: 60px;">
                </a>
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <div class="navbar-nav ms-auto">
                        <a href="spaceoverview.html" class="nav-item nav-link">瀏覽空間</a>
                        <a href="event_overview.html" class="nav-item nav-link">參與活動</a>     
                        <a href="frontend_news.html" class="nav-item nav-link">最新消息</a>
                        <a href="frontend_faq.html" class="nav-item nav-link">常見問題</a>
                    </div>
                    <!-- <a href="" class="btn btn-primary px-3 d-none d-lg-flex"> -->
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown"> <i
                                class="bi bi-person-circle">會員資料</i></a>
                        <div class="dropdown-menu rounded-0 m-0">
                            <a href="myAccount.html" class="dropdown-item">我的帳號</a>
                            <a href="events_for_user.html" class="dropdown-item">我的活動管理</a>
                            <a href="frontend_orders.html" class="dropdown-item">我的訂單管理</a>
                            <a href="#" class="dropdown-item">我的最愛</a>
                            <a href="#" class="dropdown-item">登出</a>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
        <!-- Header Navbar End -->

    <div class="container my-4">
        <h2 class="section-title">活動搜尋</h2>
        <div class="card p-4">
            <div class="row g-3">
                <div class="col-md-6 col-lg-3">
                    <label for="search" class="form-label">搜尋</label>
                    <input type="text" id="search" class="form-control" placeholder="關鍵字">
                </div>
                <div class="col-md-6 col-lg-2">
                    <label for="start-time" class="form-label">開始時間</label>
                    <input type="datetime-local" id="eventStartTime" class="form-control mb-3" name="eventStartTime">
                </div>
                <div class="col-md-6 col-lg-2">
                    <label for="end-time" class="form-label">結束時間</label>
                    <input type="datetime-local" id="eventEndTime" class="form-control mb-3" name="eventEndTime">
                </div>
                <div class="col-md-6 col-lg-2">
                    <label for="location" class="form-label">地點</label>
                    <select id="location" class="form-select">
                       <!-- <option value="">地點</option>
                        <option value="taipei">台北</option>
                        <option value="taichung">台中</option>  -->
                    </select>
                </div>
                <div class="col-md-6 col-lg-2">
    <label for="category" class="form-label">活動類別</label>
    <select id="category" class="form-select">
    	<!-- fetch 活動類別API  -->
    </select>
</div>
                <div class="col-md-12 mt-3 d-flex justify-content-center">
    				<div class="btn-group" style="width: 100%; max-width: 600px;">
        				<button class="btn btn-primary w-50" id="search-btn">尋找</button>
        				<button class="btn btn-secondary w-50" id="clear-btn">清除條件</button>
    				</div>
				</div>
            </div>
        </div>
    </div>


    <!--  標籤輪播 -->
	<div class="tag-wrapper">
    	<button class="tag-btn left-tag-btn">&lt;</button>
    	<div class="tag-container">
        <!-- fetch類別API -->
    	</div>
    	<button class="tag-btn right-tag-btn">&gt;</button>
	</div>


    <!-- 熱門推薦 -->
    <div class="container my-5">
    <div class="slide-outer">
        <h2>熱門推薦</h2>
        <div class="events-container" id="events-container">
            <!-- 活動卡片 -->
        </div>
        <!-- 分頁控制 -->
        <div class="pagination-container" id="pagination-container">
            <!-- 分頁按鈕 -->
        </div>
    </div>
</div>


     <!-- Footer Start -->
        <div class="container-fluid bg-light text-black-50 footer pt-5 mt-5 wow fadeIn" data-wow-delay="0.1s">
            <div class="container py-5">
                <div class="row g-5 align-items-center">
                    <div class="col-lg-4 col-md-4">
                        <div class="d-flex align-items-center mb-4">
                            <div class="icon p-2 me-2">
                                <img class="img-fluid" src="images/img.bootstrap/LifeSpace.png" alt="Icon" style="width: 30px; height: 30px;">
                            </div>
                            <img class="img-fluid" src="images/img.bootstrap/LifeSpace2.png" alt="Icon" style="width: 200px; height: 60px;">
                        </div>
                        <p class="mb-2"><i class="fa fa-envelope me-3"></i>lifespace105@gmail.com</p>
                    </div>

                    <div class="col-lg-8 col-md-8 ">
                        <div class="slogan-container p-4 rounded" style="background-color: rgba(255, 255, 255, 0.85); border-left: 4px solid #6c757d;">
                            <h4 class="text-primary mb-3" style="font-style: italic; font-weight: 500;">空間與活動的完美結合</h4>
                            <p class="fs-5 text-dark">選擇你的專屬場域，打造難忘回憶。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer End -->
        
    </div>

    <script src="./js/jquery-3.7.1.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> -->
    <!-- <script src="./js/event_home.js"></script> -->


 	<script src="js/wow.min.js"></script>
    <script src="js/easing.min.js"></script>
    <script src="js/waypoints.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.6.1/dist/nouislider.min.js"></script>
    <script src="js/event_overview.js"></script>
    
    <!-- Template Javascript -->
    <script src="js/main.js"></script>
    
    <script>

        // 設置全局變量以跟踪當前顯示狀態
        let currentDisplayMode = 'popular'; // 'popular' 或 'search'

        // 當文檔加載完成時執行
        document.addEventListener('DOMContentLoaded', function () {

        	//獲取所有活動類別
        	fetchAllEventsCategory();
        	
        	//獲取所有活動地點
        	fetchAllBranches();
        	
            // 獲取所有活動
            fetchAllEvents();

            // 綁定搜尋按鈕點擊事件
            document.getElementById('search-btn').addEventListener('click', function () {
                fetchEventsByConditions();
            });

            // 綁定清除按鈕點擊事件
            document.getElementById('clear-btn').addEventListener('click', function () {
                clearSearchForm();
                resetToPopularEvents();
            });
                        
        });

     	// 獲取所有活動類別
        async function fetchAllEventsCategory() {
            // 使用API端點路徑
            const apiUrl = 'http://localhost:8080/lifespace/event/getAllCategories';

            console.log('正在嘗試獲取活動類別數據，API 路徑:', apiUrl);

            fetch(apiUrl)
                .then(response => {
                    console.log('API 響應狀態:', response.status);
                    if (!response.ok) {
                        throw new Error('網路回應不正常，狀態碼: ' + response.status);
                    }
                    console.log(response);
                    return response.json();
                    console.log(response);
                })
                .then(categories => {
                    // 顯示活動類別在條件搜尋區域
                	displayCategories(categories);
                	displayCategoriesOwl(categories);
                })
                .catch(error => {
                    console.error('獲取活動類別時出錯:', error);

                });
        }

        function displayCategories(categories){
        	// 獲取活動類別下拉選單
            const categorySelect = document.getElementById('category');
            
            // 先清空原有的選項（除了預設選項）
            categorySelect.innerHTML = '<option value="">所有類別</option>';
       
            // 為每個類別添加 option
            categories.forEach(category => {
            	const newCategory = `<option value=${category.eventCategoryId}>${category.eventCategoryName}</option>`;
            	categorySelect.innerHTML = categorySelect.innerHTML  + newCategory;  
            });   
        }
        
        
        function displayCategoriesOwl(categories){

        	// 獲取類別容器
            const tagContainer = document.querySelector('.tag-container');
            
            // 清空原有內容
            tagContainer.innerHTML = '';
            
            // 動態添加類別標籤
            categories.forEach(category => {
                const tagDiv = document.createElement('div');
                tagDiv.className = 'tag';
                tagDiv.textContent = category.eventCategoryName;
                
                // 可以添加點擊事件，點擊後自動篩選該類別
                tagDiv.addEventListener('click', () => {
                    // 設定類別下拉選單的值
                    document.getElementById('category').value = category.eventCategoryId;
                    // 觸發搜尋
                    fetchEventsByConditions();
                });
                
                tagContainer.appendChild(tagDiv);
            });	
            
            // 所有標籤添加完成後，初始化輪播功能
            initializeTagCarousel();
        }
        
     // 初始化標籤輪播功能
        function initializeTagCarousel() {
            const tagContainer = $(".tag-container");
            
            // 確保有標籤元素存在
            if ($(".tag").length > 0) {
                const tagWidth = $(".tag").outerWidth(true);
                
                // 先解除現有的事件綁定，再重新綁定，避免重複綁定
                $(".left-tag-btn").off('click').on('click', function() {
                    tagContainer.animate({ scrollLeft: "-=" + tagWidth * 1.5 }, 100);
                });
                
                $(".right-tag-btn").off('click').on('click', function() {
                    tagContainer.animate({ scrollLeft: "+=" + tagWidth * 1.5 }, 100);
                });
                
                console.log("標籤輪播功能已初始化，標籤寬度：", tagWidth);
            } else {
                console.warn("沒有找到標籤元素，輪播功能未初始化");
            }
        }
     
     	// 獲取所有地點
        async function fetchAllBranches() {
    	 
        	// 使用API端點路徑
            const apiUrl = 'http://localhost:8080/branch/getAll';

            fetch(apiUrl)
                .then(response => {
                    console.log('API 響應狀態:', response.status);
                    if (!response.ok) {
                        throw new Error('網路回應不正常，狀態碼: ' + response.status);
                    }
                    return response.json();
                })
                .then(branches => {
                    // 顯示活動類別在條件搜尋區域
                	displayBranches(branches);
                })
                .catch(error => {
                    console.error('獲取活動地點時出錯:', error);
                });	
     }
     
        function displayBranches(branches){

            const branchSelect = document.getElementById('location');
            branchSelect.innerHTML = '<option value="">所有地點</option>';
            branches.forEach(branch => {
            	const newBranch = `<option value=${branch.branchId}>${branch.branchName}</option>`;
            	branchSelect.innerHTML = branchSelect.innerHTML  + newBranch;  
            });   
        }
        
        
        // 清除搜尋表單
        function clearSearchForm() {
            document.getElementById('search').value = '';
            document.getElementById('eventStartTime').value = '';
            document.getElementById('eventEndTime').value = '';
            document.getElementById('location').value = '';
            document.getElementById('category').value = ''; 
        }

        // 重置到熱門推薦
        function resetToPopularEvents() {
            // 將標題改回「熱門推薦」
            const slideOuterTitle = document.querySelector('.slide-outer h2');
            slideOuterTitle.textContent = '熱門推薦';

            // 重新獲取所有活動
            fetchAllEvents();

            // 更新顯示模式
            currentDisplayMode = 'popular';
        }

        // 修改現有的 fetchAllEvents 函數
        async function fetchAllEvents() {
            // 使用API端點路徑
            const apiUrl = 'http://localhost:8080/lifespace/event/getAll';

            console.log('正在嘗試獲取活動數據，API 路徑:', apiUrl);


            fetch(apiUrl)
                .then(response => {
                    console.log('API 響應狀態:', response.status);
                    if (!response.ok) {
                        throw new Error('網路回應不正常，狀態碼: ' + response.status);
                    }
                    console.log(response);
                    return response.json();
                    console.log(response);
                })
                .then(events => {
                    console.log('成功獲取活動數據:', events);
                    // 顯示活動在熱門推薦區域
                    displayEvents(events, '熱門推薦');
                })
                .catch(error => {
                    console.error('獲取活動時出錯:', error);

                    // 如果需要，可以在這裡放置模擬數據
                });
        }

        // 修改現有的 fetchEventsByConditions 函數
        async function fetchEventsByConditions() {
            const searchValue = document.getElementById('search').value || "";
            const startTime = document.getElementById('eventStartTime').value || "";
            const endTime = document.getElementById('eventEndTime').value || "";
            const branch = document.getElementById('location').value || "";
			const category = document.getElementById('category').value || ""; 

            // 檢查是否有任何搜尋條件
            if (!searchValue && !startTime && !endTime && !location && !category) {
                alert('請至少輸入一個搜尋條件');
                return;
            }

            const apiUrl = 'http://localhost:8080/lifespace/event/search/native?' + new URLSearchParams({
                eventName: searchValue,
                startTime: startTime,
                endTime: endTime,
                branch: branch,
                category: category,
            }).toString();

            // 避免中文關鍵字變亂碼，decodeURI
            const newUrl = decodeURI(apiUrl);
            console.log('正在嘗試獲取活動數據，API 路徑:', newUrl);

            try {
                const response = await fetch(newUrl);
                if (response.ok) {
                    const events = await response.json(); // 假設後端回傳 JSON 格式的活動列表
                    console.log('搜尋結果:', events.content);

                    // 如果沒有結果
                    if (events.content.length === 0) {
                        alert('沒有符合條件的活動');
                        return;
                    }

                    // 顯示搜尋結果
                    displayEvents(events.content, '查詢結果');

                    // 更新顯示模式
                    currentDisplayMode = 'search';
                } else {
                    alert('查詢活動失敗');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('發生錯誤，請稍後再試');
            }
        }

        // 新的統一顯示活動函數，替代原有的 displayPopularEvents
        function displayEvents(events, titleText) {
            // 獲取顯示區域
            let slider = null;
            const slideOuters = document.querySelectorAll('.slide-outer');

            for (const outer of slideOuters) {
                const titleElement = outer.querySelector('h2');
                // 修改標題為傳入的參數
                titleElement.textContent = titleText;
                slider = outer.querySelector('.slider');
                break; // 只處理第一個 slide-outer
            }

            if (!slider) {
                console.error('無法找到活動顯示區域的 slider 元素');
                return;
            }

            // 清空現有內容
            slider.innerHTML = '';

            // 確保 events 是一個數組且有數據
            if (!Array.isArray(events) || events.length === 0) {
                console.error('沒有可顯示的活動數據');
                const noEventsDiv = document.createElement('div');
                noEventsDiv.className = 'no-events';
                noEventsDiv.textContent = '沒有符合條件的活動';
                slider.appendChild(noEventsDiv);
                return;
            }

            // 添加活動到顯示區域
            events.forEach(event => {
                if (!event || !event.eventName) return;

                // 創建活動卡片 (使用 <a> 標籤)
                const slideLink = document.createElement('a');
                slideLink.className = 'slide';

                // 設定活動詳細頁面的 URL，並包含活動 ID
                slideLink.href = `event_detail.html?eventId=${event.eventId}`;

                // 活動名稱
                const slideDivName = event.eventName;

                // 格式化日期和時間
                const formattedDate = event.eventDate ? new Date(event.eventDate).toLocaleDateString() : '日期未定';
                const formattedStartTime = event.eventStartTime ? formatDateAndTime(event.eventStartTime) : '時間未定';
                const formattedEndTime = event.eventEndTime ? formatDateAndTime(event.eventEndTime) : '';

                // 取得照片 URL
                let photoUrl = '';
                if (event.photoUrls && event.photoUrls.length > 0) {
                    photoUrl = event.photoUrls[0]; // 顯示第一張照片
                }

                // 創建活動卡片內容
                let slideContent = `
            ${photoUrl ? `<img src="${'http://localhost:8080' + photoUrl}">` : '<img src="http://localhost:8080/default.jpg" alt="預設圖片">'}
            <h3>${slideDivName}</h3>
            <p>${formattedStartTime} ${formattedEndTime ? '-' + formattedEndTime : ''}</p>
        `;

                slideLink.innerHTML = slideContent;

                // 將活動卡片添加到 slider
                slider.appendChild(slideLink);
            });
        }

        // 保留原有的 formatDateAndTime 函數
        function formatDateAndTime(dateTime) {
            const date = new Date(dateTime);
            const datePart = date.toLocaleDateString();
            const timePart = date.toLocaleTimeString({ hour: '2-digit', minute: '2-digit' });
            return `${datePart} ${timePart}`;
        }

    </script>


</body>


</html>