<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>空間資料新增 - addSpace.html</title>

    <style>
        * {
            box-sizing: border-box;
            font-family: "Microsoft JhengHei", Arial, sans-serif;
        }

        body {
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }

        .form-group label {
            width: 150px;
            font-weight: bold;
            margin-right: 10px;
        }

        .form-control {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .form-control:focus {
            border-color: #6AC0BD;
            outline: none;
            box-shadow: 0 0 0 2px rgba(106, 192, 189, 0.2);
        }

        .radio-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .radio-input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            accent-color: #6AC0BD;
        }

        /* Styles for Image Preview */
        #imagePreviewContainer .preview-item {
            position: relative; /* Needed for absolute positioning of the delete button */
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        #imagePreviewContainer .preview-image {
            display: block;
            max-width: 100px; /* Adjust size as needed */
            max-height: 100px; /* Adjust size as needed */
            width: auto;
            height: auto;
            object-fit: cover; /* Ensures the image covers the area without distortion */
        }

        #imagePreviewContainer .delete-btn {
            position: absolute;
            top: -5px; /* Position slightly outside the top-right */
            right: -5px;
            background-color: rgba(255, 0, 0, 0.7); /* Semi-transparent red */
            color: white;
            border: none;
            border-radius: 50%; /* Make it circular */
            width: 20px;
            height: 20px;
            font-size: 12px;
            line-height: 18px; /* Center the 'X' vertically */
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        #imagePreviewContainer .delete-btn:hover {
            background-color: rgba(255, 0, 0, 1); /* Solid red on hover */
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /*提交按鈕設定*/
        .submit-btn {
            background-color: #6AC0BD;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .submit-btn:hover {
            background-color: #475757;
        }

        /*錯誤訊息*/
        #errorMessages {
            color: #f44336;
            margin-bottom: 15px;
        }

        #errorMessages ul {
            margin: 0;
            padding-left: 20px;
        }

        #successMessage {
            color: green;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        /* 新增空間設備彈窗 */
        dialog {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            min-width: 300px; /* Minimum width */
            max-width: 90%; /* Maximum width relative to viewport */
            margin: auto; /* Center horizontally and vertically (for browsers supporting it) */
        }

        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent backdrop */
        }

        dialog h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 18px;
            text-align: center;
        }

        dialog form div {
            margin-bottom: 15px;
        }

        dialog form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        dialog form input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            line-height: 1;
            cursor: pointer;
            padding: 0;
        }

        .modal-actions {
            text-align: right;
            margin-top: 20px;
        }
        .modal-actions button {
            padding: 8px 15px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #confirmAddEquipmentBtn {
            background-color: #6AC0BD;
            color: white;
        }
        #confirmAddEquipmentBtn:hover {
            background-color: #475757;
        }
        #cancelEquipmentModalBtn {
            background-color: #ccc;
        }
        #cancelEquipmentModalBtn:hover {
            background-color: #aaa;
        }


        /* Style for the Add Equipment Button */
        .btn-add-equipment {
            background-color: #f0f0f0;
            border: 1px dashed #ccc;
            color: #555;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .btn-add-equipment:hover {
            background-color: #e9e9e9;
            border-color: #aaa;
        }

        /* Styles for Displayed Equipment Items */
        #equipmentDisplayArea .equipment-item {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex; /* Align item text and delete button */
            justify-content: space-between; /* Push delete button to the right */
            align-items: center;
            font-size: 15px;
        }

        #equipmentDisplayArea .equipment-item-text {
            /* Takes up available space */
            flex-grow: 1;
            margin-right: 10px; /* Space before delete button */
        }

        #equipmentDisplayArea .equipment-item-delete {
            background: none;
            border: none;
            color: #f44336; /* Red color for delete */
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 0 5px;
        }
        #equipmentDisplayArea .equipment-item-delete:hover {
            color: #d32f2f; /* Darker red on hover */
        }


        @media screen and (max-width: 768px) {
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }

            .form-group label {
                margin-bottom: 5px;
                width: 100%;
            }

            .form-control {
                width: 100%;
            }
        }
    </style>
    <!-- <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_Maps_API_KEY&libraries=places&callback=initMap" async
        defer></script> -->

</head>

<body>
<div class="container">
    <!-- 錯誤表列 -->
    <div id="errorMessages"></div>

    <!-- 成功表列 -->
    <div id="successMessage"></div>

    <h1>資料新增:</h1>

    <!-- 資料新增表單 -->
    <form id="spaceForm" name="form1">

        <div class="form-group">
            <label for="branchId">所屬分店:</label>
            <select id="branchId" name="branchId" class="form-control" size="1">
                <option value="">讀取中...</option>
            </select>
        </div>

        <div class="form-group">
            <label for="spaceName">空間名稱:</label>
            <input type="text" id="spaceName" name="spaceName" class="form-control" value="">
        </div>

        <div class="form-group">
            <label for="spacePhotos">空間照片:</label>
            <input type="file" id="spacePhotos" name="spacePhotos" class="form-control" multiple accept="image/*">
        </div>
        <div class="form-group">
            <label></label>
            <div id="imagePreviewContainer" style="display: flex; flex-wrap: wrap; gap: 10px;">
            </div>
        </div>

        <div class="form-group">
            <label for="spacePeople">空間人數:</label>
            <input type="number" id="spacePeople" name="spacePeople" class="form-control" value="">
        </div>

        <div class="form-group">
            <label for="spaceSize">空間大小 (坪):</label>
            <input type="number" id="spaceSize" name="spaceSize" class="form-control" value="">
        </div>

        <div class="form-group">
            <label for="spaceHourlyFee">時租費率 (NT$):</label>
            <input type="number" id="spaceHourlyFee" name="spaceHourlyFee" class="form-control" value="">
        </div>

        <div class="form-group">
            <label for="spaceDailyFee">日租費率 (NT$):</label>
            <input type="number" id="spaceDailyFee" name="spaceDailyFee" class="form-control" value="">
        </div>

        <div class="form-group">
            <label for="spaceUsageId">空間用途:</label>
            <select id="spaceUsageId" name="spaceUsageId" class="form-control" multiple size="5">
                <option value="">讀取中...</option>
            </select>
        </div>

        <div class="form-group">
            <label>空間設備:</label>
            <div style="flex: 1; display: flex; flex-direction: column; align-items: flex-start;">
                <button type="button" id="addEquipmentBtn" class="btn-add-equipment">
                    + 新增空間設備
                </button>

<!--                顯示目前的空間設備-->
                <div id="equipmentDisplayArea" style="margin-top: 10px; width: 100%;">
                </div>

                <input type="hidden" id="equipmentDataInput" name="equipmentData">
            </div>
        </div>

        <div class="form-group">
            <label for="spaceDesc">空間介紹:</label>
            <textarea id="spaceDesc" name="spaceDesc" class="form-control"></textarea>
        </div>

        <div class="form-group">
            <label for="spaceAlert">重要公告:</label>
            <textarea id="spaceAlert" name="spaceAlert" class="form-control"></textarea>
        </div>

        <div class="form-group">
            <label>空間狀態:</label>
            <div class="radio-group">
                <label class="radio-label">
                    <input type="radio" name="spaceStatus" value="0" class="radio-input" checked>
                    稍後上架
                </label>
                <label class="radio-label">
                    <input type="radio" name="spaceStatus" value="1" class="radio-input">
                    直接上架
                </label>
            </div>
        </div>

        <div class="form-group">
            <label for="spaceFloor">空間所在樓層:</label>
            <input type="text" id="spaceFloor" name="spaceFloor" class="form-control" value="">
        </div>

        <div style="text-align: center;">
            <button type="button" id="submitBtn" class="submit-btn">完成</button>
        </div>

        <!--新增空間設備彈窗-->
        <dialog id="equipmentModal">
            <form method="dialog" id="equipmentModalForm"><h2>新增空間設備</h2>
                <button type="button" id="closeEquipmentModalBtn" class="modal-close-btn" aria-label="Close">&times;
                </button>
                <div>
                    <label for="equipmentNameInput">設備名稱:</label>
                    <input type="text" id="equipmentNameInput" required>
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancelEquipmentModalBtn">取消</button>
                    <button type="button" id="confirmAddEquipmentBtn">完成</button>
                </div>
            </form>
        </dialog>
    </form>
</div>

<script>
    // ======== Configuration ========
    // 絕對路徑 (fetch)
    const APP_CONTEXT_PATH = "http://localhost:8080";
    const ADD_SPACE_URL = `${APP_CONTEXT_PATH}/spaces`;

    // 相對路徑 (async)
    const GET_ALL_BRANCHES_URL = "branch/getAllBranches";
    const GET_ALL_SPACES_USAGES_URL = "/space-usages";

    const form = document.getElementById('spaceForm');
    const submitButton = document.getElementById('submitBtn');
    const errorDiv = document.getElementById('errorMessages');
    const successDiv = document.getElementById('successMessage');

    // ======== 顯示錯誤訊息 ========
    function displayErrors(errors) {
        const errorDiv = document.getElementById('errorMessages');
        errorDiv.innerHTML = ''; // 清除之前的錯誤


        const successDiv = document.getElementById('successMessage');
        if (successDiv) successDiv.innerHTML = ''; // Clear success message

        // 在表單最上方新增錯誤訊息
        if (errors && Array.isArray(errors) && errors.length > 0) { // // 如果errors是Json
            const list = document.createElement('ul');
            errors.forEach(msg => {
                // 檢查msg是object還是string
                const text = (typeof msg === 'object' && msg.defaultMessage) ? msg.defaultMessage : msg;
                const item = document.createElement('li');
                item.textContent = text;
                list.appendChild(item);
            });
            errorDiv.appendChild(list);
        } else if (errors) { // 如果errors是String
            errorDiv.textContent = errors;
        }
    }

    // 顯示提交成功的訊息 (以後應該不會用到)
    function displaySuccess(message) {
        const successDiv = document.getElementById('successMessage');
        if (successDiv) {
            successDiv.textContent = message;
            const errorDiv = document.getElementById('errorMessages');
            if (errorDiv) errorDiv.innerHTML = '';
        }
    }

    // 預覽空間照片
    // 利用DataTransfer物件管理上傳的檔案
    function setupImagePreview() {
        const spacePhotosInput = document.getElementById('spacePhotos');
        const previewContainer = document.getElementById('imagePreviewContainer');
        const fileStore = new DataTransfer();

        if (!spacePhotosInput || !previewContainer) return;   // 如果沒有照片可預覽，則不執行以下的程式

        spacePhotosInput.addEventListener('change', handleFileSelect);

        function handleFileSelect(e) {
            const files = e.target.files; // 抓出剛剛選擇的檔案

            // 新增檔案到DataTransfer物件裡
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    fileStore.items.add(file);
                } else {
                    console.warn(`${file.name} 檔案規格不符，無法上傳`);
                }
            }
            spacePhotosInput.files = fileStore.files;   // 將DataTransfer的檔案送進file input欄位（input這是要傳給資料庫的）
            renderPreviews();   // 執行照片預覽功能
        }

        // 照片預覽
        function renderPreviews() {
            previewContainer.innerHTML = ''; // 清除預覽照片

            // 讀取Data Transfer裡的照片
            Array.from(fileStore.files).forEach((file, index) => {
                const reader = new FileReader();    // 利用File Reader讀取照片

                reader.onload = function (e) {
                    const previewItem = document.createElement('div');  // 建立一個顯示照片的div
                    previewItem.classList.add('preview-item');

                    const img = document.createElement('img');  // 建立img元素
                    img.classList.add('preview-image');  // CSS
                    console.log(e.target);
                    img.src = e.target.result; // 將img src設為剛剛存入的照片來源
                    img.alt = file.name;

                    // 在整個div的右上角新增刪除按鈕
                    const deleteBtn = document.createElement('button');
                    deleteBtn.classList.add('delete-btn');  // CSS
                    deleteBtn.innerHTML = '&times;'; // '×' symbol
                    deleteBtn.type = 'button'; // 注意：button的default type值為"submit"，為了預防按到刪除按鈕時表單直接被送出，需改成type="button"
                    deleteBtn.title = `移除 ${file.name}`; // title: hover在X上時顯示文字

                    // 點擊叉叉執行移除
                    deleteBtn.addEventListener('click', () => {
                        removeFile(index);
                    });

                    // 將圖片及叉叉按鈕加進div中
                    previewItem.appendChild(img);
                    previewItem.appendChild(deleteBtn);

                    // div加進預覽照片container中
                    previewContainer.appendChild(previewItem);
                }

                // 展示預覽照片
                reader.readAsDataURL(file);
            });
        }

        // 移除預覽照片
        function removeFile(index) {
            // Remove the file from the store based on its index
            fileStore.items.remove(index);

            // Update the input's files property
            spacePhotosInput.files = fileStore.files;

            // Re-render the previews
            renderPreviews();
        }
    }


    // ========== AJAX CRUD ==========
    // --- 1. POST: 新增空間 ---
    submitButton.addEventListener('click', function () {    // 點擊「完成」按鈕時要做的事
        // 移除成功、錯誤訊息
        errorDiv.innerHTML = '';
        successDiv.innerHTML = '';  //  這行可以不用

        const formData = new FormData(form); // formData可以用來處理HTML表單

        let errors = [];    // 蒐集錯誤資訊

        // 檢查空間照片（一定要選擇至少一張）
        const photoInput = document.getElementById('spacePhotos');
        if (!photoInput || photoInput.files.length === 0) {
            // Make photos optional or required based on your needs
            errors.push('請至少選擇一張空間照片。');
        }

        if (errors.length > 0) {
            displayErrors(errors);
            return; // 如果有錯誤訊息就不執行接下來的程式
        }

        // 傳送資料時，將按鈕disabled，以免重複上傳
        submitButton.disabled = true;
        submitButton.textContent = '傳送中...';

        // 提交request body
        fetch(ADD_SPACE_URL, {
            method: 'POST',
            body: formData      // 如果request body是multipart/form-data，這邊就不用指定content-type，而且也不用JSON stringify formData
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {  // 回傳JSON
                        const backendErrors = errorData.errors || errorData.message || `伺服器錯誤: ${response.status}`;    // 依序先抓JSON中的errors, message，如果都沒有，就代表是500
                        throw backendErrors;    // 拋出例外給外層的catch
                    }).catch(() => {
                        // 回傳的JSON格式有誤，拋出例外給外層的catch
                        throw [`伺服器發生錯誤: ${response.status} ${response.statusText}`];
                    });
                }
                return response.json(); // 回傳JSON，成功就是剛剛新增的JSON，失敗就是回傳錯誤訊息的JSON回傳格式範例：{ success: true, message: "..." }
            })
            .then(data => {
                // Handle successful response from backend
                console.log("Success Response:", data); // Log success data
                // 下面那一行可以把他砍了
                displaySuccess(data.message || '空間新增成功！');
                form.reset(); // 務必要清空清空表單

                // 重新導向：2秒後跳轉到listAllSpaces.html
                setTimeout(() => {
                    window.location.href = 'listAllSpaces.html';
                }, 2000);
            })
            .catch(errorOrErrors => {
                console.error('提交時發生錯誤:', errorOrErrors);
            })
            .finally(() => {
                // 提交完成後，要將按鈕回復
                submitButton.disabled = false;
                submitButton.textContent = '完成';
            });
    });

    // --- 2. GET: 取得分店列表 ---
    async function fetchBranches() {
        const selectElement = document.getElementById('branchId');
        const loadingOptionText = '讀取中...';
        const defaultOptionText = '請選擇分點';

        // 載入時寫讀取中
        selectElement.innerHTML = `<option value="">${loadingOptionText}</option>`;
        selectElement.disabled = true; // 把空間用途label disabled

        try {
            const response = await fetch(GET_ALL_BRANCHES_URL); // 抓Controller裡的網址抓過來，需利用相對網址，請自行到branch overloading方法

            if (!response.ok) {
                // 處理404或500
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            // 解析取得所有空間用途回傳JSON
            // [{ branchId: 'B001', branchName: '南京復興', ... }, ...]
            const branches = await response.json();

            // 把loading刪除
            selectElement.innerHTML = '';

            // 將下拉式清單顯示為「請選擇分點」
            const defaultOption = document.createElement('option');
            defaultOption.value = ""; // 「請選擇分點」option的value值為空值
            defaultOption.textContent = defaultOptionText;   // 請選擇分點
            defaultOption.disabled = true; // 將預設option作為placeholder
            defaultOption.selected = true;
            selectElement.appendChild(defaultOption);

            // 將資料丟進下拉式清單
            if (branches && branches.length > 0) {
                branches.forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch.branchId;  // 將value值設為「分點編號」
                    option.textContent = branch.branchName;  // 將value值設為「分點名稱」
                    selectElement.appendChild(option);
                });
                selectElement.disabled = false; // 如果有選項，則enable下拉式清單
            }

        } catch (error) {
            console.error('Error fetching branches:', error);
        }
    }


    // --- 3. GET: 取得空間用途列表 ---
    async function fetchSpaceUsages() {
        const spaceUsageSelectElement = document.getElementById('spaceUsageId');  // 抓空間用途下拉式清單元素

        // 抓不到下拉式清單時錯誤處理
        if (!spaceUsageSelectElement) {
            console.error("Element with ID 'spaceUsageId' not found.");
            return;
        }

        const loadingOptionText = '讀取中...';

        spaceUsageSelectElement.innerHTML = `<option disabled>${loadingOptionText}</option>`;   // 「讀取中...」選項，並設為disabled
        spaceUsageSelectElement.disabled = true;

        try {
            const response = await fetch(GET_ALL_SPACES_USAGES_URL); // 從後端抓資料

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const spaceUsagesData = await response.json(); // 解析JSON

            // 將「讀取中...」移除
            spaceUsageSelectElement.innerHTML = '';

            if (spaceUsagesData && spaceUsagesData.length > 0) {
                // 抓資料
                spaceUsagesData.forEach(usage => {
                    if (usage.spaceUsageStatus !== "DELETED") {     // 檢查狀態，必須為AVAILABLE才會顯示
                        const option = document.createElement('option');
                        option.value = usage.spaceUsageId;
                        option.textContent = usage.spaceUsageName;
                        spaceUsageSelectElement.appendChild(option);
                    }
                });
                // 載入完成後，enable那些選項
                spaceUsageSelectElement.disabled = false;
            }

        } catch (error) {
            console.error('Error fetching space usages:', error);
        }
    }

    // ======== Initialization (載入網頁時要做的事情) ========
    document.addEventListener('DOMContentLoaded', function () {
        fetchBranches(); // 抓分店

        fetchSpaceUsages(); // 抓空間用途

        setupImagePreview();  // 設定預覽照片功能
    });
</script>
</body>
</html>