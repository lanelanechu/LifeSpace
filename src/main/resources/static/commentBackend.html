<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeSpace 後台管理系統 - 留言管理</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <link href="/css/commentsbackend.css" rel="stylesheet">
</head>
<body>

<button class="btn btn-primary d-md-none m-2" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
    <i class="fas fa-bars"></i>
</button>
<div class="container-fluid">
    <div class="row">
        <!-- 側邊欄 -->
        <div class="col-lg-2 sidebar">
            <div class="sidebar-header">
                <img src="/images/img.bootstrap/LifeSpace3.png" alt="LifeSpace Logo" class="sidebar-logo">
                <h2 class="sidebar-title">後台中心</h2>
            </div>
            <ul class="nav flex-column mt-3">
                <!-- 消息管理 -->
                <li class="nav-item">
                    <a href="#newsSubmenu" data-bs-toggle="collapse" class="nav-link">
                        <i class="fas fa-home"></i> 消息管理
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <ul class="collapse submenu" id="newsSubmenu">
                        <li><a href="#" class="submenu-item">最新消息</a></li>
                    </ul>
                </li>

                <!-- 帳號管理 -->
                <li class="nav-item">
                    <a href="#accountSubmenu" data-bs-toggle="collapse" class="nav-link">
                        <i class="fas fa-user"></i> 帳號管理
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <ul class="collapse submenu" id="accountSubmenu">
                        <li><a href="#" class="submenu-item">會員帳號</a></li>
                        <li><a href="#" class="submenu-item">管理員帳號</a></li>
                    </ul>
                </li>

                <!-- 空間訂單管理 -->
                <li class="nav-item">
                    <a href="#ordersSubmenu" data-bs-toggle="collapse" class="nav-link">
                        <i class="fas fa-map-marker-alt"></i> 空間訂單管理
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <ul class="collapse submenu" id="ordersSubmenu">
                        <li><a href="#" class="submenu-item">訂單</a></li>
                    </ul>
                </li>

                <!-- 商品管理 -->
                <li class="nav-item">
                    <a href="#productSubmenu" data-bs-toggle="collapse" class="nav-link">
                        <i class="fas fa-box"></i> 商品管理
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <ul class="collapse submenu" id="productSubmenu">
                        <li><a href="#" class="submenu-item">空間管理</a></li>
                        <li><a href="#" class="submenu-item">租借品項</a></li>
                        <li><a href="#" class="submenu-item">分點</a></li>
                    </ul>
                </li>

                <!-- 活動留言評論管理 -->
                <li class="nav-item">
                    <a href="#commentSubmenu" data-bs-toggle="collapse" class="nav-link active">
                        <i class="fas fa-star"></i> 活動留言評論管理
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <ul class="collapse submenu show" id="commentSubmenu">
                        <li><a href="#" class="submenu-item">活動留言板</a></li>
                        <li><a href="#" class="submenu-item">檢舉留言</a></li>
                    </ul>
                </li>

                <!-- 常見問題管理 -->
                <li class="nav-item">
                    <a href="#faqSubmenu" data-bs-toggle="collapse" class="nav-link">
                        <i class="fas fa-headset"></i> 常見問題管理
                        <i class="fas fa-chevron-down ms-auto"></i>
                    </a>
                    <ul class="collapse submenu" id="faqSubmenu">
                        <li><a href="#" class="submenu-item">常見問題</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <!-- 側邊欄 -->

        <!-- 自己的表格內容 -->
        <div class="col-lg-10 col-md-9 ms-auto px-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="mb-0">活動留言板管理</h2>
                    <div class="profile-icon"><i class="bi bi-person-fill"></i></div>
                </div>
                <div class="card-body">
                    <!-- 篩選條件 -->
                    <div class="row mb-3">
                        <div class="col-md-2">
                            <select id="filterBoardType" class="form-select">
                                <option value="">選擇活動板</option>
                                <option value="團康版">團康版</option>
                                <option value="學習版">學習版</option>
                                <option value="語言版">語言版</option>
                                <option value="興趣版">興趣版</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select id="filterRegion" class="form-select">
                                <option value="">選擇地區</option>
                                <option value="中山區">中山區</option>
                                <option value="松山區">松山區</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="date" id="filterDate" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <input type="time" id="filterTime" class="form-control">
                        </div>
                        <div class="col-md-2">
                            <button id="searchBtn" class="btn btn-primary">搜尋</button>
                        </div>
                        <div class="col-md-2">
                            <button id="addCommentBtn" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCommentModal">新增留言</button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table id="commentsTable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <th>留言編號</th>
                                    <th>會員編號</th>
                                    <th>留言內容</th>
                                    <th>留言時間</th>
                                    <th>顯示狀態</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新增留言 Modal -->
<div class="modal fade" id="addCommentModal" tabindex="-1" aria-labelledby="addCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCommentModalLabel">新增留言</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCommentForm">
                    <div class="mb-3">
                        <label for="eventMemberId" class="form-label">會員編號</label>
                        <input type="text" class="form-control" id="eventMemberId" required>
                    </div>
                    <div class="mb-3">
                        <label for="commentMessage" class="form-label">留言內容</label>
                        <textarea class="form-control" id="commentMessage" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="submitAddComment">確認新增</button>
            </div>
        </div>
    </div>
</div>

<!-- 編輯留言 Modal -->
<div class="modal fade" id="editCommentModal" tabindex="-1" aria-labelledby="editCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCommentModalLabel">編輯留言</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCommentForm">
                    <input type="hidden" id="editCommentId">
                    <div class="mb-3">
                        <label for="editEventMemberId" class="form-label">會員編號</label>
                        <input type="text" class="form-control" id="editEventMemberId" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editCommentMessage" class="form-label">留言內容</label>
                        <textarea class="form-control" id="editCommentMessage" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="submitEditComment">確認修改</button>
            </div>
        </div>
    </div>
</div>

<!-- 錯誤訊息 Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <p id="modal-error-message" class="mb-3 fs-5 fw-bold text-dark"></p>
            <button type="button" class="btn btn-danger d-block mx-auto" data-bs-dismiss="modal">確定</button>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="/vendors/jquery/jquery-3.7.1.min.js"></script>

<!-- Bootstrap JS -->
<script src="/vendors/bootstrap/bootstrap.bundle.min.js"></script>

<!-- DataTables -->
<script src="/vendors/dataTables/dataTables.min.js"></script>
<script src="/vendors/dataTables/dataTables.bootstrap5.min.js"></script>

<script>
    $(document).ready(function () {
        // 初始化DataTable
        var commentsTable = $('#commentsTable').DataTable({
            
            language: {
                lengthMenu: "", // 拿掉 "每頁顯示 _MENU_ 筆資料"
                search: "", // 拿掉搜尋欄前面的 "搜尋:"
                info: "顯示第 _START_ 到第 _END_ 筆資料，共 _TOTAL_ 筆",
                paginate: {
                    first: "第一頁",
                    previous: "上一頁",
                    next: "下一頁",
                    last: "最後一頁"
                }
            },
            lengthChange: false, // 隱藏 lengthMenu 選單本體（下拉式選單）
            searching: false, // 隱藏搜尋框本體
            
            ajax: {
                url: '/comments',
                dataSrc: function(json) {
                    // 將後端資料轉換為DataTable需要的格式
                    return json.map(function(item) {
                        return {
                            commentId: item.commentId,
                            eventMember: item.eventMember ? item.eventMember.eventMemberId : 'N/A',
                            commentMessage: item.commentMessage,
                            commentTime: formatDateTime(item.commentTime),
                            commentHide: item.commentHide
                        };
                    });
                }
            },
            columns: [
                { data: 'commentId' },
                { data: 'eventMember' },
                { data: 'commentMessage' },
                { data: 'commentTime' },
                { 
                    data: 'commentHide',
                    render: function(data) {
                        if (data === 'VISIBLE') {
                            return '<span class="badge bg-success">顯示中</span>';
                        } else {
                            return '<span class="badge bg-danger">已隱藏</span>';
                        }
                    }
                },
                {
                    data: null,
                    render: function(data, type, row) {
                        const hideShowBtn = row.commentHide === 'VISIBLE' ? 
                            `<button class="btn btn-sm btn-hide toggle-visibility-btn" data-id="${row.commentId}" data-status="VISIBLE">隱藏</button>` :
                            `<button class="btn btn-sm btn-show toggle-visibility-btn" data-id="${row.commentId}" data-status="HIDDEN">顯示</button>`;
                        
                        return `
                            <button class="btn btn-sm btn-primary edit-btn" data-id="${row.commentId}">編輯</button>
                            ${hideShowBtn}
                        `;
                    }
                }
            ],
            createdRow: function(row, data, dataIndex) {
                // 如果留言被隱藏，為該行添加特殊樣式
                if (data.commentHide === 'HIDDEN') {
                    $(row).addClass('comment-status-hidden');
                }
            },
            order: [[3, 'desc']] // 依留言時間排序
        });

        // 格式化日期時間
        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
        }

        // 搜尋按鈕事件
        $('#searchBtn').click(function() {
            const boardType = $('#filterBoardType').val();
            const region = $('#filterRegion').val();
            const date = $('#filterDate').val();
            const time = $('#filterTime').val();
            
            // 重新載入DataTable並帶入搜尋參數
            commentsTable.ajax.url(`/comments?boardType=${encodeURIComponent(boardType)}&region=${encodeURIComponent(region)}&date=${encodeURIComponent(date)}&time=${encodeURIComponent(time)}`).load();
        });

        // 切換留言顯示/隱藏狀態
        $('#commentsTable').on('click', '.toggle-visibility-btn', function() {
            const commentId = $(this).data('id');
            const currentStatus = $(this).data('status');
            const newStatus = currentStatus === 'VISIBLE' ? 'HIDDEN' : 'VISIBLE';
            
            $.ajax({
                url: `/comments/${commentId}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    commentId: commentId,
                    commentHide: newStatus
                }),
                success: function() {
                    commentsTable.ajax.reload();
                },
                error: function(xhr) {
                    $('#modal-error-message').text(xhr.responseText || '操作失敗');
                    $('#errorModal').modal('show');
                }
            });
        });

        // 編輯留言按鈕事件
        $('#commentsTable').on('click', '.edit-btn', function() {
            const commentId = $(this).data('id');
            
            // 獲取當前留言資料
            $.ajax({
                url: `/comments/${commentId}`,
                type: 'GET',
                success: function(comment) {
                    $('#editCommentId').val(comment.commentId);
                    $('#editEventMemberId').val(comment.eventMember.eventMemberId);
                    $('#editCommentMessage').val(comment.commentMessage);
                    $('#editCommentModal').modal('show');
                },
                error: function(xhr) {
                    $('#modal-error-message').text(xhr.responseText || '獲取留言資料失敗');
                    $('#errorModal').modal('show');
                }
            });
        });

        // 提交編輯留言
        $('#submitEditComment').click(function() {
            const commentId = $('#editCommentId').val();
            const commentMessage = $('#editCommentMessage').val();
            
            if (!commentMessage.trim()) {
                alert('留言內容不能為空');
                return;
            }
            
            $.ajax({
                url: `/comments/${commentId}`,
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({
                    commentId: commentId,
                    commentMessage: commentMessage
                }),
                success: function() {
                    $('#editCommentModal').modal('hide');
                    commentsTable.ajax.reload();
                },
                error: function(xhr) {
                    $('#modal-error-message').text(xhr.responseText || '修改留言失敗');
                    $('#errorModal').modal('show');
                }
            });
        });

        // 提交新增留言
        $('#submitAddComment').click(function() {
            const eventMemberId = $('#eventMemberId').val();
            const commentMessage = $('#commentMessage').val();
            
            if (!eventMemberId.trim() || !commentMessage.trim()) {
                alert('請填寫所有必填欄位');
                return;
            }
            
            $.ajax({
                url: '/comments',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    eventMember: {
                        eventMemberId: eventMemberId
                    },
                    commentMessage: commentMessage,
                    commentHide: 'VISIBLE'
                }),
                success: function() {
                    $('#addCommentModal').modal('hide');
                    $('#addCommentForm')[0].reset();
                    commentsTable.ajax.reload();
                },
                error: function(xhr) {
                    $('#modal-error-message').text(xhr.responseText || '新增留言失敗');
                    $('#errorModal').modal('show');
                }
            });
        });
    });
</script>
</body>
</html>